trigger:
  branches:
    include:
      - main
      - master

resources:
  repositories:
    - repository: self
      type: github
      name: Bluerate90/ServiceExample-DevOps
      ref: main
      trigger: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  imageRepository: 'serviceexample'
  containerRegistry: 'myappregistry1.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/docker/Dockerfile'
  tag: '$(Build.BuildId)'
  imageName: '$(containerRegistry)/$(imageRepository):$(tag)'
  DOTNET_VERSION: '9.0.x'
  SonarCloudOrg: '777m'

stages:
  # ============ STAGE 1: BUILD & TEST ============
  - stage: BuildAndTest
    displayName: 'Build & Test Application'
    jobs:
      - job: BuildJob
        displayName: 'Build & Run Tests'
        steps:
          - task: UseDotNet@2
            inputs:
              version: $(DOTNET_VERSION)
            displayName: 'Install .NET 9'

          - script: dotnet restore ServiceExample/ServiceExample/ServiceExample.csproj
            displayName: 'Restore NuGet Packages'

          - script: dotnet build ServiceExample/ServiceExample/ServiceExample.csproj --configuration $(buildConfiguration) --no-restore
            displayName: 'Build Application'

          - script: dotnet test ServiceExample/ServiceExample/ServiceExample.csproj --configuration $(buildConfiguration) --no-build --logger trx --collect:"XPlat Code Coverage"
            displayName: 'Run Unit Tests'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TEST-*.trx'
            displayName: 'Publish Test Results'
            condition: always()

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'
            displayName: 'Publish Code Coverage'
            condition: always()

  # ============ STAGE 2: BUILD DOCKER IMAGE ============
  - stage: BuildDocker
    displayName: 'Build Docker Image'
    dependsOn: BuildAndTest
    condition: succeeded()
    jobs:
      - job: DockerJob
        displayName: 'Build & Push Docker Image'
        steps:
          - task: Docker@2
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(imageName)
                $(containerRegistry)/$(imageRepository):latest
            displayName: 'Build Docker Image'

          - script: |
              echo "Getting ACR credentials..."
              ACR_PASSWORD=$(az acr credential show --name myappregistry1 --query passwords[0].value -o tsv)
              echo "##vso[task.setvariable variable=ACR_PASSWORD;issecret=true]$ACR_PASSWORD"
            displayName: 'Get ACR Credentials'

          - script: |
              echo "Logging in to Azure Container Registry..."
              docker login -u myappregistry1 -p $(ACR_PASSWORD) $(containerRegistry)
              echo "Pushing Docker image to registry..."
              docker push $(imageName)
              docker push $(containerRegistry)/$(imageRepository):latest
            displayName: 'Push to Azure Container Registry'

  # ============ STAGE 3: SCAN DOCKER IMAGE ============
  - stage: ScanContainer
    displayName: 'Scan Docker Image'
    dependsOn: BuildDocker
    condition: succeeded()
    jobs:
      - job: ContainerScanJob
        displayName: 'Scan Image for Vulnerabilities'
        steps:
          - script: |
              echo "Installing Trivy..."
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install -y trivy
              echo "Running Trivy image scan..."
              trivy image --severity HIGH,CRITICAL $(imageName)
            displayName: 'Run Trivy Image Scan'
            continueOnError: true

  # ============ STAGE 4: SIGN IMAGE ============
  - stage: SignImage
    displayName: 'Sign Docker Image'
    dependsOn: ScanContainer
    condition: succeeded()
    jobs:
      - job: SignJob
        displayName: 'Sign Image with Cosign'
        steps:
          - script: |
              echo "Downloading Cosign v2.0.0..."
              wget https://github.com/sigstore/cosign/releases/download/v2.0.0/cosign-linux-amd64
              chmod +x cosign-linux-amd64
              sudo mv cosign-linux-amd64 /usr/local/bin/cosign
              cosign version
              echo "Cosign installation completed"
            displayName: 'Install Cosign'
            continueOnError: true

          - script: |
              echo "Image ready for signing: $(imageName)"
              echo "Note: Configure cosign keys in Azure Key Vault for production signing"
            displayName: 'Prepare for Image Signing'
            continueOnError: true